# üéØ RAG Reranking Strategies - Implementation Guide

## üìã –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–ª—è RAG (Retrieval-Augmented Generation), –∫–æ—Ç–æ—Ä–∞—è —É–ª—É—á—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø—É—Ç–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ—Å–ª–µ vector search.

## ‚ùå –ü–æ—á–µ–º—É –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–ª—å–∫–æ `similarityThreshold`?

### –ü—Ä–æ–±–ª–µ–º—ã –±–∞–∑–æ–≤–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:

1. **–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ä–æ–≥ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**
   - –ï—Å–ª–∏ –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–º–µ—é—Ç score 0.4-0.5, –ø–æ—Ä–æ–≥ 0.3 –ø—Ä–æ–ø—É—Å—Ç–∏—Ç –≤—Å—ë
   - –ï—Å–ª–∏ –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–º–µ–µ—Ç score 0.9, —Å–ª–µ–¥—É—é—â–∏–π —Å 0.31 –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º

2. **–ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç false positives**
   - High similarity ‚â† semantic relevance
   - Keyword matching –º–æ–∂–µ—Ç –¥–∞—Ç—å –≤—ã—Å–æ–∫–∏–π score –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –ø–æ–ª–µ–∑–Ω–æ—Å—Ç–∏

3. **–¢–µ—Ä—è–µ—Ç—Å—è –∫–æ–Ω—Ç–µ–∫—Å—Ç**
   - Chunk –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ—Ö–æ–∂ –Ω–∞ –∑–∞–ø—Ä–æ—Å, –Ω–æ –Ω–µ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å
   - –ù–µ—Ç —É—á—ë—Ç–∞ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ–ª—É—á–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π score)

4. **–ù–µ—Ç –∞–¥–∞–ø—Ç–∞—Ü–∏–∏**
   - –û–¥–∏–Ω –ø–æ—Ä–æ–≥ –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
   - –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞—á–µ—Å—Ç–≤–æ embedding –º–æ–¥–µ–ª–∏

## üîÑ –î–≤—É—Ö—ç—Ç–∞–ø–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å

### Phase 1: Vector Search
```kotlin
// ChunkVectorStorage.searchSimilarChunks()
val rankedResults = repoStorage
    .rankDocuments(query)
    .toList()
    .sortedByDescending { it.similarity }
    .take(topK)
```
- –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ø-N —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ—Ç vector search
- **–í–∞–∂–Ω–æ**: —Ç–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–µ similarity scores (—Ä–∞–Ω—å—à–µ —Ç–µ—Ä—è–ª–∏—Å—å!)

### Phase 2: Reranking/Filtering
```kotlin
// RAGService.getRelevantContext()
val rerankingStrategy = createRerankingStrategy(threshold)
val rerankedResults = rerankingStrategy.rerank(query, initialResults)
```
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤—ã–±—Ä–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

## üìä –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

### 1. `NONE` - Baseline (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏)
```kotlin
rerankingStrategy = RerankingStrategyType.NONE
```
**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –î–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –¥—Ä—É–≥–∏–º–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏

**–ö–æ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è—Ç—å:**
- –û—Ç–ª–∞–¥–∫–∞
- A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ê–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞ embeddings

**–ü–ª—é—Å—ã:** –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π recall
**–ú–∏–Ω—É—Å—ã:** –ù–∏–∑–∫–∏–π precision, –º–Ω–æ–≥–æ —à—É–º–∞

---

### 2. `THRESHOLD` - –ü—Ä–æ—Å—Ç–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–æ—Ä–æ–≥—É (default)
```kotlin
rerankingStrategy = RerankingStrategyType.THRESHOLD
similarityThreshold = 0.3
```
**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –§–∏–ª—å—Ç—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å similarity < threshold

**–ö–æ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è—Ç—å:**
- –ò–∑–≤–µ—Å—Ç–µ–Ω –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –ø—Ä–∏–µ–º–ª–µ–º—ã–π score –¥–ª—è –≤–∞—à–µ–π –º–æ–¥–µ–ª–∏
- –ù—É–∂–Ω–∞ –ø—Ä–æ—Å—Ç–æ—Ç–∞ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å
- –°—Ç–∞–±–∏–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ embeddings

**–ü–ª—é—Å—ã:** –ü—Ä–æ—Å—Ç–æ—Ç–∞, –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å
**–ú–∏–Ω—É—Å—ã:** –ù–µ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é scores

**–ü—Ä–∏–º–µ—Ä –ª–æ–≥–æ–≤:**
```
üìä Vector search returned 20 chunks
Similarity distribution: min=0.2145, max=0.7823, avg=0.4521
üéØ After reranking (threshold-0.3): 15 chunks (filtered out: 5)
```

---

### 3. `ADAPTIVE` - –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–æ—Ä–æ–≥
```kotlin
rerankingStrategy = RerankingStrategyType.ADAPTIVE
adaptiveThresholdRatio = 0.8  // –î–µ—Ä–∂–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 80% –æ—Ç –ª—É—á—à–µ–≥–æ
```
**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–æ—Ä–æ–≥ = `bestScore * adaptiveThresholdRatio`

**–ö–æ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è—Ç—å:**
- –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
- –†–∞–∑–Ω—ã–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Å —Ä–∞–∑–Ω—ã–º –ø–æ–∫—Ä—ã—Ç–∏–µ–º
- –ù—É–∂–Ω–∞ –∞–¥–∞–ø—Ç–∞—Ü–∏—è –∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É

**–ü–ª—é—Å—ã:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è
**–ú–∏–Ω—É—Å—ã:** –ú–æ–∂–µ—Ç –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–º best score

**–ü—Ä–∏–º–µ—Ä—ã:**
- –õ—É—á—à–∏–π score 0.9 ‚Üí –ø–æ—Ä–æ–≥ 0.72 (0.9 * 0.8)
- –õ—É—á—à–∏–π score 0.4 ‚Üí –ø–æ—Ä–æ–≥ 0.32 (0.4 * 0.8)

---

### 4. `SCORE_GAP` - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–∞–∑—Ä—ã–≤—É scores
```kotlin
rerankingStrategy = RerankingStrategyType.SCORE_GAP
scoreGapThreshold = 0.15  // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑—Ä—ã–≤ –º–µ–∂–¥—É —Å–æ—Å–µ–¥–Ω–∏–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
```
**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –±–æ–ª—å—à–æ–º –ø–∞–¥–µ–Ω–∏–∏ similarity

**–ö–æ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è—Ç—å:**
- –ï—Å—Ç—å —è–≤–Ω–∞—è –≥—Ä—É–ø–ø–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –ù—É–∂–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å "–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π" –ø–æ—Ä–æ–≥
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ñ–æ—Ä–º–∏—Ä—É—é—Ç –∫–ª–∞—Å—Ç–µ—Ä—ã

**–ü–ª—é—Å—ã:** –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
**–ú–∏–Ω—É—Å—ã:** –ú–æ–∂–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è —Å–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ

**–ü—Ä–∏–º–µ—Ä:**
```
Scores: 0.85, 0.82, 0.79, 0.48, 0.45, 0.43
        ‚Üë     ‚Üë     ‚Üë     ‚Üì GAP=0.31 > 0.15 ‚Üí STOP!
–†–µ–∑—É–ª—å—Ç–∞—Ç: –ø–µ—Ä–≤—ã–µ 3 chunk
```

---

### 5. `MMR` - Maximal Marginal Relevance
```kotlin
rerankingStrategy = RerankingStrategyType.MMR
mmrLambda = 0.7  // 1.0 = —á–∏—Å—Ç–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å, 0.0 = —á–∏—Å—Ç–æ–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ
```
**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –ë–∞–ª–∞–Ω—Å–∏—Ä—É–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –∏ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ

**–§–æ—Ä–º—É–ª–∞:** `MMR = Œª * Relevance - (1-Œª) * MaxSimilarity`

**–ö–æ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è—Ç—å:**
- –ù—É–∂–Ω–æ –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤/–ø–æ—Ö–æ–∂–∏—Ö chunks
- –í–∞–∂–Ω–æ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ä–∞–∑–Ω—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ –∫–æ–¥–∞
- LLM –Ω—É–∂–µ–Ω —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç

**–ü–ª—é—Å—ã:** –£–º–µ–Ω—å—à–∞–µ—Ç –∏–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å
**–ú–∏–Ω—É—Å—ã:** –í—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–æ –¥–æ—Ä–æ–∂–µ, –º–æ–∂–µ—Ç —É–ø—É—Å—Ç–∏—Ç—å –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏

**–ü—Ä–∏–º–µ—Ä—ã lambda:**
- 0.9 - –∞–∫—Ü–µ–Ω—Ç –Ω–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å (–º–∏–Ω–∏–º—É–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏)
- 0.7 - –±–∞–ª–∞–Ω—Å (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
- 0.5 - —Å–∏–ª—å–Ω–æ–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ

---

### 6. `MULTI_CRITERIA` - –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏
```kotlin
rerankingStrategy = RerankingStrategyType.MULTI_CRITERIA
similarityThreshold = 0.3
```
**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –ö–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–∫—Ç–æ—Ä–æ–≤:
- Similarity score
- –î–ª–∏–Ω–∞ chunk (min 50 —Å–∏–º–≤–æ–ª–æ–≤)
- –¢–∏–ø chunk (function –ø–æ–ª—É—á–∞–µ—Ç boost 1.2x)
- –ù–∞–ª–∏—á–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (function/class names: boost 1.1x)

**–ö–æ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è—Ç—å:**
- –ù—É–∂–µ–Ω –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –ø–æ–¥—Ö–æ–¥
- –í–∞–∂–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –∫–æ–¥–∞
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è–º –Ω–∞–¥ file-level chunks

**–ü–ª—é—Å—ã:** –£—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É
**–ú–∏–Ω—É—Å—ã:** –°–ª–æ–∂–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å, –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–ª–∏—à–Ω–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–º

---

### 7. `OLLAMA_CONTEXTUAL_EMBEDDINGS` - –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ embeddings —á–µ—Ä–µ–∑ Ollama ‚≠ê NEW!
```kotlin
rerankingStrategy = RerankingStrategyType.OLLAMA_CONTEXTUAL_EMBEDDINGS
ollamaRerankTruncateChunks = true  // –û–±—Ä–µ–∑–∞—Ç—å –¥–ª–∏–Ω–Ω—ã–µ chunks –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
ollamaRerankMaxChunkLength = 1000  // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ chunk
```
**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π semantic similarity —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ embeddings

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
```kotlin
// –í–º–µ—Å—Ç–æ –æ–±—ã—á–Ω–æ–≥–æ:
similarity = cosine(embed(query), embed(chunk))

// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –ø–æ–¥—Ö–æ–¥:
similarity = cosine(
    embed("Represent this query for retrieving relevant code: $query"),
    embed("Represent this code for answering query '$query': $chunk")
)
```

**–ö–æ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è—Ç—å:**
- –ò–º–µ—é—â–∏–π—Å—è Ollama —Å embedding –º–æ–¥–µ–ª—å—é
- –ù—É–∂–Ω–∞ –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å —á–µ–º –æ–±—ã—á–Ω—ã–π cosine similarity
- –í–∞–∂–Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç LLM judge)
- 2-3 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ reranking –ø—Ä–∏–µ–º–ª–µ–º—ã

**–ü–ª—é—Å—ã:**
- ‚úÖ –ë–æ–ª–µ–µ —Ç–æ—á–Ω–æ —á–µ–º bi-encoder (–æ–±—ã—á–Ω—ã–µ embeddings)
- ‚úÖ –£—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏ encoding
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–º–µ—é—â—É—é—Å—è Ollama –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–æ (–Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç LLM –ø–∞—Ä—Å–∏–Ω–≥–∞)
- ‚úÖ –ë—ã—Å—Ç—Ä–µ–µ —á–µ–º LLM-as-judge (~2-3 —Å–µ–∫—É–Ω–¥—ã)

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –¢—Ä–µ–±—É–µ—Ç N+1 –≤—ã–∑–æ–≤–æ–≤ –∫ Ollama (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
- ‚ùå –ú–µ–¥–ª–µ–Ω–Ω–µ–µ —á–µ–º pure threshold —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `LLMEmbedder` —Å `MULTILINGUAL_E5` –º–æ–¥–µ–ª—å—é
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ embeddings —á–µ—Ä–µ–∑ coroutines
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±—Ä–µ–∑–∞–Ω–∏–µ –¥–ª–∏–Ω–Ω—ã—Ö chunks (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

**–ü—Ä–∏–º–µ—Ä –ª–æ–≥–æ–≤:**
```
üîÑ Starting contextual embedding reranking for 20 chunks
‚úÖ Got query embedding
‚úÖ Contextual reranking complete: 10 chunks in 2314ms
Top result: similarity=0.8235
```

---

## üìà –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π

| –°—Ç—Ä–∞—Ç–µ–≥–∏—è | Precision | Recall | Diversity | –°–∫–æ—Ä–æ—Å—Ç—å | –°–ª–æ–∂–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ |
|-----------|-----------|--------|-----------|----------|---------------------|
| NONE      | Low       | High   | Low       | ‚ö°‚ö°‚ö°    | ‚≠ê                  |
| THRESHOLD | Medium    | Medium | Low       | ‚ö°‚ö°‚ö°    | ‚≠ê‚≠ê                |
| ADAPTIVE  | Medium    | Medium | Low       | ‚ö°‚ö°‚ö°    | ‚≠ê‚≠ê                |
| SCORE_GAP | Medium    | Medium | Low       | ‚ö°‚ö°‚ö°    | ‚≠ê                  |
| MMR       | High      | Medium | High      | ‚ö°‚ö°      | ‚≠ê‚≠ê‚≠ê              |
| MULTI     | High      | Medium | Medium    | ‚ö°‚ö°‚ö°    | ‚≠ê‚≠ê‚≠ê‚≠ê            |

## üß™ –ö–∞–∫ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ

### 1. –õ–æ–≥–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –º–µ—Ç—Ä–∏–∫–∏:

```kotlin
// RAGContext —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ reranking
data class RAGContext(
    val rerankingInfo: RerankingInfo? = RerankingInfo(
        strategyUsed = "adaptive-0.8",
        initialCount = 20,
        finalCount = 12,
        filteredOut = 8,
        topSimilarities = [0.78, 0.74, 0.69, 0.66, 0.61]
    )
)
```

### 2. –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç:
```
üìä Vector search returned 20 chunks
Similarity distribution: min=0.2145, max=0.7823, avg=0.4521
üéØ After reranking (adaptive-0.8): 12 chunks (filtered out: 8)
Top result: similarity=0.7823, file=src/main/kotlin/Service.kt
```

### 3. A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

**–ë–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ (NONE):**
```kotlin
rerankingStrategy = RerankingStrategyType.NONE
```
- –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
- –û—Ü–µ–Ω–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–∞ LLM
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ chunks –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ

**–° —Ñ–∏–ª—å—Ç—Ä–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, ADAPTIVE):**
```kotlin
rerankingStrategy = RerankingStrategyType.ADAPTIVE
adaptiveThresholdRatio = 0.8
```
- –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ—Ç –∂–µ –∞–Ω–∞–ª–∏–∑
- –°—Ä–∞–≤–Ω–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–∞
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏: `filteredOut`, `topSimilarities`

### 4. –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ü–µ–Ω–∫–∏:

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ:**
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö chunks
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ similarity scores
- –¢–æ–ø-5 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

**–†—É—á–Ω—ã–µ:**
- –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å chunks –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ (precision)
- –ü–æ–ª–Ω–æ—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (recall)
- –ö–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–∞ LLM
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤—ã–±–æ—Ä—É —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

### –î–ª—è production —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø!): ‚≠ê
```kotlin
rerankingStrategy = RerankingStrategyType.OLLAMA_CONTEXTUAL_EMBEDDINGS
ollamaRerankTruncateChunks = true
ollamaRerankMaxChunkLength = 1000
```
**–ü—Ä–∏—á–∏–Ω—ã:**
- –í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å reranking
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–º–µ—é—â—É—é—Å—è Ollama
- –°—Ç–∞–±–∏–ª—å–Ω–æ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ
- 2-3 —Å–µ–∫—É–Ω–¥—ã –ø—Ä–∏–µ–º–ª–µ–º—ã –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞

### –î–ª—è production (–±—ã—Å—Ç—Ä—ã–π –≤–∞—Ä–∏–∞–Ω—Ç):
```kotlin
rerankingStrategy = RerankingStrategyType.ADAPTIVE
adaptiveThresholdRatio = 0.8
```
**–ü—Ä–∏—á–∏–Ω—ã:** –•–æ—Ä–æ—à–∏–π –±–∞–ª–∞–Ω—Å, –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É, –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ

### –î–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:
```kotlin
rerankingStrategy = RerankingStrategyType.SCORE_GAP
scoreGapThreshold = 0.15
```
**–ü—Ä–∏—á–∏–Ω—ã:** –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü, —Ö–æ—Ä–æ—à–æ –¥–ª—è exploratory queries

### –î–ª—è –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã —Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏:
```kotlin
rerankingStrategy = RerankingStrategyType.MMR
mmrLambda = 0.7
```
**–ü—Ä–∏—á–∏–Ω—ã:** –£–º–µ–Ω—å—à–∞–µ—Ç –∏–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å, –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ

### –î–ª—è —Ñ–æ–∫—É—Å–∞ –Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è—Ö:
```kotlin
rerankingStrategy = RerankingStrategyType.MULTI_CRITERIA
```
**–ü—Ä–∏—á–∏–Ω—ã:** –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥, —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–ª—É—á–∞—é—Ç boost

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### application.conf:
```hocon
embeddings {
  enabled = true
  reranking-strategy = "OLLAMA_CONTEXTUAL_EMBEDDINGS"  # –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è!
  # –ò–ª–∏: ADAPTIVE, THRESHOLD, SCORE_GAP, MMR, MULTI_CRITERIA, NONE

  similarity-threshold = 0.3
  adaptive-threshold-ratio = 0.8
  score-gap-threshold = 0.15
  mmr-lambda = 0.7

  # Ollama reranking (–¥–ª—è OLLAMA_CONTEXTUAL_EMBEDDINGS)
  ollama-rerank-truncate-chunks = true
  ollama-rerank-max-chunk-length = 1000
}
```

### –ü—Ä–æ–≥—Ä–∞–º–º–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞:
```kotlin
val config = EmbeddingConfig(
    enabled = true,
    rerankingStrategy = RerankingStrategyType.OLLAMA_CONTEXTUAL_EMBEDDINGS,
    similarityThreshold = 0.3,

    // Ollama reranking parameters
    ollamaRerankTruncateChunks = true,
    ollamaRerankMaxChunkLength = 1000
)
```

### –ë—ã—Å—Ç—Ä–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
```kotlin
// –¢–µ—Å—Ç 1: –ë–µ–∑ reranking
config.copy(rerankingStrategy = RerankingStrategyType.NONE)

// –¢–µ—Å—Ç 2: –ü—Ä–æ—Å—Ç–æ–π –ø–æ—Ä–æ–≥
config.copy(rerankingStrategy = RerankingStrategyType.THRESHOLD)

// –¢–µ—Å—Ç 3: Ollama contextual (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)
config.copy(rerankingStrategy = RerankingStrategyType.OLLAMA_CONTEXTUAL_EMBEDDINGS)
```

## üìä –ü—Ä–∏–º–µ—Ä—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### –ü—Ä–∏–º–µ—Ä 1: THRESHOLD vs ADAPTIVE

**–ó–∞–ø—Ä–æ—Å:** "authentication logic"

**THRESHOLD (0.3):**
```
Initial: 20 chunks (min=0.21, max=0.78, avg=0.45)
Final: 15 chunks
Filtered: 5 chunks (–≤—Å–µ —Å score < 0.3)
```

**ADAPTIVE (0.8):**
```
Initial: 20 chunks (min=0.21, max=0.78, avg=0.45)
Adaptive threshold: 0.624 (0.78 * 0.8)
Final: 8 chunks
Filtered: 12 chunks
```
‚Üí ADAPTIVE –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç, –Ω–æ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ –∫–∞—á–µ—Å—Ç–≤—É –ª—É—á—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

### –ü—Ä–∏–º–µ—Ä 2: NONE vs MMR

**–ó–∞–ø—Ä–æ—Å:** "database connection"

**NONE:**
```
20 chunks: –º–Ω–æ–≥–æ –ø–æ—Ö–æ–∂–∏—Ö connection setup —Ñ—É–Ω–∫—Ü–∏–π
```

**MMR (lambda=0.7):**
```
10 chunks: connection setup, error handling, pooling, retry logic, etc.
–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–º–µ—Å—Ç–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
```

## üéì –í—ã–≤–æ–¥—ã

1. **–ë–∞–∑–æ–≤—ã–π `similarityThreshold` –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω** - –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ
2. **–î–≤—É—Ö—ç—Ç–∞–ø–Ω—ã–π –ø–æ–¥—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª—É—á—à–µ** - —Å–Ω–∞—á–∞–ª–∞ vector search, –∑–∞—Ç–µ–º reranking
3. **–†–∞–∑–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∑–∞–¥–∞—á** - –Ω–µ—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è
4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω–æ** - –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
5. **–ù–∞—á–Ω–∏—Ç–µ —Å ADAPTIVE** - —Ö–æ—Ä–æ—à–∏–π –±–∞–ª–∞–Ω—Å –∏–∑ –∫–æ—Ä–æ–±–∫–∏

## üìù –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **LLM-based reranking** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å LLM –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
2. **Hybrid search** - –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å semantic + keyword (BM25)
3. **Cross-encoder –º–æ–¥–µ–ª—å** - —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è reranking
4. **User feedback** - —É—á–∏—Ç—ã–≤–∞—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
5. **Query classification** - —Ä–∞–∑–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤
